<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Image annotator</title>

		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
	<body>
		<header style="height:20px">
		</header>
		<center>

			<div>
				<h1>Hi, hello</h1>
			</div>

			<div>
				<!--- Hardcoded... get rid of it eventually -->
				<p class="lead" id="info-text">You are currently on frame 1 / 100</p>
			</div>

			<div id="container">

				<!-- hidden canvas and image to conver images to matrices -->
				<canvas id="hcanvas" width="640" height="400"></canvas>
				<canvas id="hcanvas2" width="640" height="400"></canvas>

				<div id="holder"></div>

			</div>

			<div class="btn-group" role="group" aria-label="...">
				<button id="back_bttn" type="button" class="btn btn-default">
					<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
				</button>
				<button id="play_bttn" type="button" class="btn btn-default">
					<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
				</button>
				<button id="pause_bttn" type="button" class="btn btn-default">
					<span class="glyphicon glyphicon-pause" aria-hidden="true"></span>
				</button>
				<button id="stop_bttn" type="button" class="btn btn-default">
					<span class="glyphicon glyphicon-stop" aria-hidden="true"></span>
				</button>
				<button id="fwd_bttn" type="button" class="btn btn-default">
					<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
				</button>
			</div>

			<!--
			<div id="holder"></div>
			-->

		</center>

		<!-- sprintf is super useful -->
		<script src="js/sprintf.min.js"></script>
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

		<!-- optical flow -->
		<script src="js/oflow.js"></script>
		<!-- raphael-js for svg on canvas -->
		<script src="js/raphael-min.js"></script>

		<script>

			// Make the raphael canvas available outside its local function
			var r;
			var img_path = 'imgs/undercam/cam1logfile1/cam1logfile1_%05d.jpeg';

			window.onload = function () {
				r = Raphael("holder", 640, 480),

				// Handles are black, they have no line around them.
				discattr = {fill: "#fff", stroke: "none"};

				// Draw the current image on the back of the canvas.
				r.image( sprintf(img_path, 1), 0,0,640,480);

				// Draw a rectangle around the imag and put some instructions.
				r.rect(0, 0, 640, 480, 0).attr({stroke: "#666"});
				r.text(310, 20, "Drag the points to change the curves").attr({fill: "#fff", "font-size": 16});

				function curve(hx, hy, lax, lay, llx, lly, rlx, rly, rax, ray, color) {
					// Draw the lines in svg format.
					var path = [["M", hx, hy], ["L", lax, lay], ["L", llx, lly], ["L", rlx, rly], ["L", rax, ray], ["L", hx, hy]],
					curve = r.path(path).attr({stroke: color || Raphael.getColor(), "stroke-width": 4, "stroke-linecap": "round"}),
					// Draw the control points.
					controls = r.set(
						r.circle(hx, hy, 5).attr(discattr),
						r.circle(lax, lay, 5).attr(discattr),
						r.circle(llx, lly, 5).attr(discattr),
						r.circle(rlx, rly, 5).attr(discattr),
						r.circle(rax, ray, 5).attr(discattr)
					);
					// Set control listeners for all the points.
					controls[0].update = function (x, y) {
						var X = this.attr("cx") + x, Y = this.attr("cy") + y;
						this.attr({cx: X, cy: Y});
						path[0][1] = X; path[0][2] = Y;
						path[5][1] = X; path[5][2] = Y;
						curve.attr({path: path});
						console.log('X:' + X + " Y: " + Y);
					};
					controls[1].update = function (x, y) {
						var X = this.attr("cx") + x, Y = this.attr("cy") + y;
						this.attr({cx: X, cy: Y});
						path[1][1] = X; path[1][2] = Y;
						curve.attr({path: path});
						console.log('X:' + X + " Y: " + Y);
					};
					controls[2].update = function (x, y) {
						var X = this.attr("cx") + x, Y = this.attr("cy") + y;
						this.attr({cx: X, cy: Y});
						path[2][1] = X; path[2][2] = Y;
						curve.attr({path: path});
						console.log('X:' + X + " Y: " + Y);
					};
					controls[3].update = function (x, y) {
						var X = this.attr("cx") + x, Y = this.attr("cy") + y;
						this.attr({cx: X, cy: Y});
						path[3][1] = X; path[3][2] = Y;
						curve.attr({path: path});
						console.log('X:' + X + " Y: " + Y);
					};
					controls[4].update = function (x, y) {
						var X = this.attr("cx") + x, Y = this.attr("cy") + y;
						this.attr({cx: X, cy: Y});
						path[4][1] = X; path[4][2] = Y;
						curve.attr({path: path});
						console.log('X:' + X + " Y: " + Y);
					};
					controls.drag(move, up);
				} // end curve

				//function polyrat( headx, heady, larmx, larmy, rarmx, rarmy, llegx, llegy, rlegx, rlegy, bodyx, bodyy, tailx, taily ) {i

				//}

				function move(dx, dy) {
					this.update(dx - (this.dx || 0), dy - (this.dy || 0));
					this.dx = dx;
					this.dy = dy;
				}
				function up() {
					this.dx = this.dy = 0;
				}
				var headx = 329, heady = 341;
				var larmx = 317, larmy = 409;
				var llegx = 231, llegy = 430;
				var rlegx = 265, rlegy = 440;
				var rarmx = 310, rarmy = 420;
				curve( headx, heady, larmx, larmy, llegx, llegy, rlegx, rlegy, rarmx, rarmy, "hsb(0, .75, .75)");
			};

			var NIMAGES = 100;
			var play                // this is set to stop the playing when paused or stopped
			var current_image = 1;  // the image we are looking at.Drag
			$('#pause_bttn').hide() // since we are not playing initially

			// preload images
			var annotate_images={};
			for (i=0;i<NIMAGES;i++) {
				annotate_images[i] = new Image();
				var fname = sprintf( img_path, [i+1] ); // Name of the image file.
				annotate_images[i].src = fname
			}

			//$('#himg').attr('src', sprintf( img_path, 1 ));
			var img_matrix_1,
				img_matrix_2,
				tmp_img_1 = new Image(),
				tmp_img_2 = new Image(),
				ctx  = $('#hcanvas')[0].getContext("2d");
				ctx2 = $('#hcanvas2')[0].getContext("2d");

			// Load the first image.
			tmp_img_1.src    = sprintf( img_path, 15 );
			tmp_img_1.onload = function() {

				ctx.drawImage( tmp_img_1, 0, 0 );
				img_matrix_1 = ctx.getImageData(0, 0, 640, 480).data;

				// Load the second image.
				tmp_img_2.src = sprintf( img_path, 16);
				tmp_img_2.onload = function() {

					ctx2.drawImage( tmp_img_2, 0, 0 );
					img_matrix_2 = ctx2.getImageData(0, 0, 640, 480).data;

					console.log( img_matrix_1 );
					console.log( img_matrix_2 );

					// Compute optical flow
					flow = new oflow.FlowCalculator;
					optical_flow = flow.calculate( img_matrix_1, img_matrix_2, 640, 480 );
					console.log( optical_flow );

				}
			}



			// updates the frame details
			function update_image() {
				var fname = sprintf( img_path, [current_image]); // Name of the image file.
				r.image(fname,0,0,640,480);
				$('#to_annotate').attr('src', fname); // Actually load the image.
				var new_text = sprintf('You are currently on frame %d / %d', current_image, NIMAGES);
				$('#info-text').text( new_text ); // Update the text at the top
			}

			// set frame no to frame_no
			function set_frame( frame_no ) {
				current_image  = frame_no;
				update_image();
			}

			// moves ahead by no_of_frame --- can take negative no. and go back
			function advance_frame(no_of_frame){
				var temp_current_image = current_image + no_of_frame;
				if (temp_current_image > NIMAGES){
					current_image = NIMAGES;
					}else if  (temp_current_image < 1){
					current_image = 1;
					}else{
					current_image = temp_current_image;
				}
				update_image();
				return ;
			}

			$('#fwd_bttn').click(function () {
				advance_frame(1);
			});

			//currently playing speed is set to 10fps
			$('#play_bttn').click(function () {
				$('#play_bttn').toggle();
				$('#pause_bttn').toggle();
				play = window.setInterval(function() {
					advance_frame(1);
					if (current_image == NIMAGES){
						window.clearInterval(play);
					}
				},100);
			});

			$('#pause_bttn').click(function () {
			$('#play_bttn').toggle();
			$('#pause_bttn').toggle();
			window.clearInterval(play);
			});

			$('#stop_bttn').click(function () {
			window.clearInterval(play);
			$('#play_bttn').show();
			$('#pause_bttn').hide();
			set_frame(1);
			});

			$('#back_bttn').click( function() {
			advance_frame(-1);
			});


		</script>

	</body>

</html>
